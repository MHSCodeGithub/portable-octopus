<!doctype html>
<html>
  <head>
    <title>Kingdom | Octable Portopus</title>
    <link rel="stylesheet" href="game.css">
    <script src="panzoom/test/libs/jquery.js"></script>
    <script src="panzoom/dist/jquery.panzoom.js"></script>
    <script src="panzoom/test/libs/jquery.mousewheel.js"></script>
  </head>
  <body>
    <!-- ## Depracted chat system ## (IGNORE)
    <div id="chat">
      <ul id="chat-output"></ul>
      <form id="chat-input" action="">
        <input id="message" autocomplete="off" /><button>Send</button>
      </form>
    </div>
    -->
    <section id="game">
      <div class="parent">
        <div class="panzoom">
          <div id="game-container">

          </div>
        </div>
      </div>
    </section>
    <script>
      (function() {
        var $section = $('#game');
        var $panzoom = $section.find('.panzoom').panzoom();
        $panzoom.parent().on('mousewheel.focal', function( e ) {
          e.preventDefault();
          var delta = e.delta || e.originalEvent.wheelDelta;
          var zoomOut = delta ? delta < 0 : e.originalEvent.deltaY > 0;
          $panzoom.panzoom('zoom', zoomOut, {
            animate: false,
            focal: e
          });
        });
      })();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return false;
      }

      var username = getCookie("username");
      var password = getCookie("password");

      if(!username || !password) {
        alert("Critical Error Please Login Again. (Reset session by re-opening browser)");
      }

      var me = {};

      $(function () {
        var socket = io.connect('http://localhost:3000');

        /* ## Depracted chat system ## (IGNORE)
        var now = new Date();
        $('#chat-input').submit(function(){
          if($('#message').val() != "") {
            socket.emit('chat message', {content: $('#message').val(), author: username, timeStamp: String(now.getUTCHours()+":"+now.getUTCMinutes()+":"+now.getUTCSeconds())});
            $('#message').val('');
          }
          return false;
        });*/

        // ## Depracted chat system ## (IGNORE)
        socket.on('chat message', function(msg){ // <-- Required for bug fix
          /*$('#chat-output').append($('<li>').text("["+msg.timeStamp+"] ["+msg.author+"] "+msg.content));
          $("#chat-output").animate({ scrollTop: $("#chat-output")[0].scrollHeight - $("#chat-output").height() }, 100);*/
        });

        socket.on('result', function (message) {
          alert(message);
        });

        function drawLine(startY, startX, color, endY, endX, id) {
          if(startX < endX) {
            for (var i = 0; i < (endX-startX)+1; i++) {
              $(".y-"+startY+".x-"+(i+startX)).css("background", color).addClass(id);
            }
          } else if(startX > endX) {
            for (var i = 0; i < (startX-endX)+1; i++) {
              $(".y-"+startY+".x-"+(startX-i)).css("background", color).addClass(id);
            }
          } else if(startY < endY) {
            for (var i = 0; i < (endY-startY)+1; i++) {
              $(".y-"+(i+startY)+".x-"+startX).css("background", color).addClass(id);
            }
          } else if(startY > endY) {
            for (var i = 0; i < (startY-endY)+1; i++) {
              $(".y-"+(endY-i)+".x-"+startX).css("background", color).addClass(id);
            }
          }
        }

        var total = 0;
        for (var i = 0; i < 100; i++) {
          for (var j = 0; j < 100; j++) {
            total++;
            $("#game-container").append("<div id='block-"+(total)+"' class='y-"+(i+1)+" x-"+(j+1)+"'> </div>");
          }
        }

        function drawHouse(startX, startY, id) {
          /*
            dark: #654321
            med: #785027
            light: #8b5d2e
          */

          drawLine(startY+1, startX+3, "#654321", startY+7, startX+3, "house-"+id);
          drawLine(startY+7, startX+3, "#654321", startY+11, startX+7, "house-"+id);
          drawLine(startY+1, startX+4, "#785027", startY+6, startX+4, "house-"+id);
          drawLine(startY+6, startX+5, "#785027", startY+9, startX+7, "house-"+id);
          drawLine(startY+1, startX+5, "#8b5d2e", startY+5, startX+5, "house-"+id);
          drawLine(startY+5, startX+6, "#8b5d2e", startY+9, startX+7, "house-"+id);
          drawLine(startY+1, startX+1, "#8b5d2e", startY+8, startX+1, "house-"+id);
          drawLine(startY+1, startX+2, "#785027", startY+8, startX+2, "house-"+id);
          drawLine(startY+8, startX+3, "#785027", startY+12, startX+7, "house-"+id);
          drawLine(startY+9, startX+1, "#8b5d2e", startY+13, startX+7, "house-"+id);
        }

        drawHouse(1, 1, 0);

        $(".info").click(function () {
          $(this).hide();
        })

        $(".house-0").click(function () {
          if($(this).children().length == 0) {
            var classes = $(this).attr('class').split(" ");
            var x = classes[1].split("-")[1],
                y = classes[0].split("-")[1];

            $(this).append("<div class='info'></div>")
          } else {
            $(this).children().hide();
          }
        });
      });
    </script>
  </body>
</html>
